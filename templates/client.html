{% extends "base.html" %}

{% block title %}Interface Client - Protocole SET/CDA{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold text-white mb-3" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
            <i class="bi bi-cart-fill"></i> Interface Client
        </h1>
        <p class="text-white lead" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
            Effectuez des achats s√©curis√©s avec le protocole SET/CDA
        </p>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bag-check-fill"></i>
                Nouvelle Transaction S√©curis√©e
            </div>
            <div class="card-body">
                <form id="achat-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-person-badge me-2"></i>Client
                            </label>
                            <select class="form-select" id="client-select" required>
                                <option value="">S√©lectionnez un client...</option>
                                {% for nom in clients.keys() %}
                                <option value="{{ nom }}">{{ nom }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-shop me-2"></i>Marchand
                            </label>
                            <select class="form-select" id="marchand-select" required>
                                <option value="">S√©lectionnez un marchand...</option>
                                {% for nom in marchands.keys() %}
                                <option value="{{ nom }}">{{ nom }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-list-ul me-2"></i>Articles
                            </label>
                            <div id="items-container">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control item-input" 
                                           placeholder="Ex: Livre Python, Ordinateur portable..." required>
                                    <button class="btn btn-outline-danger remove-item-btn" type="button" disabled>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-item-btn">
                                <i class="bi bi-plus-circle me-1"></i> Ajouter un article
                            </button>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-currency-euro me-2"></i>Montant Total (‚Ç¨)
                            </label>
                            <input type="number" class="form-control" id="montant-input" 
                                   min="0.01" step="0.01" placeholder="0.00" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-wallet2 me-2"></i>Solde Disponible
                            </label>
                            <div class="form-control bg-light" id="solde-display">
                                <span class="text-muted">S√©lectionnez un client</span>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">
                                    <i class="bi bi-shield-lock-fill me-2"></i>
                                    S√©curit√© de la Transaction
                                </h6>
                                <ul class="mb-0 small">
                                    <li>üîê Vos informations de paiement seront chiffr√©es avec RSA 2048 bits</li>
                                    <li>‚úçÔ∏è La transaction sera sign√©e num√©riquement pour garantir l'authenticit√©</li>
                                    <li>üîí Le marchand ne verra PAS votre num√©ro de carte</li>
                                    <li>‚úÖ Un certificat X.509 validera votre identit√©</li>
                                    <li>‚è±Ô∏è Protection anti-rejeu avec timestamp et nonce</li>
                                </ul>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submit-btn">
                                <i class="bi bi-lock-fill me-2"></i>
                                Effectuer l'Achat S√©curis√©
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle-fill"></i>
                Informations
            </div>
            <div class="card-body">
                <h6 class="fw-bold mb-3">Processus de Transaction</h6>
                <div class="timeline">
                    <div class="mb-3">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle bg-primary text-white p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <small class="fw-bold">1</small>
                            </div>
                            <div>
                                <strong>Pr√©paration</strong>
                                <p class="mb-0 small text-muted">G√©n√©ration de l'Order Info et Payment Info</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle bg-primary text-white p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <small class="fw-bold">2</small>
                            </div>
                            <div>
                                <strong>Chiffrement</strong>
                                <p class="mb-0 small text-muted">PI chiffr√© avec la cl√© publique de la banque</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle bg-primary text-white p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <small class="fw-bold">3</small>
                            </div>
                            <div>
                                <strong>Signature</strong>
                                <p class="mb-0 small text-muted">Double signature (OI + PI chiffr√©)</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle bg-primary text-white p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <small class="fw-bold">4</small>
                            </div>
                            <div>
                                <strong>Envoi</strong>
                                <p class="mb-0 small text-muted">Transmission au marchand</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex align-items-start">
                            <div class="rounded-circle bg-success text-white p-2 me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                <small class="fw-bold">‚úì</small>
                            </div>
                            <div>
                                <strong>Validation</strong>
                                <p class="mb-0 small text-muted">V√©rification marchand + autorisation banque</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-wallet2"></i>
                Recharger mon Compte
            </div>
            <div class="card-body">
                <form id="recharge-form">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-person-badge me-2"></i>Client
                        </label>
                        <select class="form-select" id="client-recharge-select" required>
                            <option value="">S√©lectionnez un client...</option>
                            {% for nom in clients.keys() %}
                            <option value="{{ nom }}">{{ nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-currency-euro me-2"></i>Montant √† Recharger (‚Ç¨)
                        </label>
                        <input type="number" class="form-control" id="montant-recharge-input" 
                               min="1" max="10000" step="1" placeholder="Ex: 500" required>
                        <small class="text-muted">Maximum: 10 000‚Ç¨</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Solde Actuel</label>
                        <div class="form-control bg-light" id="solde-actuel-recharge">
                            <span class="text-muted">S√©lectionnez un client</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-plus-circle-fill me-2"></i>
                        Recharger le Compte
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i>
                Mes Derniers Achats
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="historique-container">
                    <p class="text-muted text-center">S√©lectionnez un client</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let soldesData = {};

    fetch('/api/soldes')
        .then(response => response.json())
        .then(data => {
            soldesData = data;
        });

    document.getElementById('client-select').addEventListener('change', function() {
        const client = this.value;
        const soldeDisplay = document.getElementById('solde-display');
        
        if (client && soldesData[client]) {
            const solde = soldesData[client].solde;
            soldeDisplay.innerHTML = `<strong class="text-success fs-5">${solde}‚Ç¨</strong>`;
        } else {
            soldeDisplay.innerHTML = '<span class="text-muted">S√©lectionnez un client</span>';
        }
    });

    document.getElementById('add-item-btn').addEventListener('click', function() {
        const container = document.getElementById('items-container');
        const newItem = document.createElement('div');
        newItem.className = 'input-group mb-2';
        newItem.innerHTML = `
            <input type="text" class="form-control item-input" placeholder="Nom de l'article" required>
            <button class="btn btn-outline-danger remove-item-btn" type="button">
                <i class="bi bi-trash"></i>
            </button>
        `;
        container.appendChild(newItem);
        
        newItem.querySelector('.remove-item-btn').addEventListener('click', function() {
            newItem.remove();
        });
    });

    document.getElementById('achat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading me-2"></span> Transaction en cours...';
        
        const client = document.getElementById('client-select').value;
        const marchand = document.getElementById('marchand-select').value;
        const montant = parseFloat(document.getElementById('montant-input').value);
        
        const items = Array.from(document.querySelectorAll('.item-input'))
            .map(input => input.value.trim())
            .filter(item => item !== '');
        
        fetch('/api/acheter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                client: client,
                marchand: marchand,
                items: items,
                montant: montant
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('‚úÖ Transaction r√©ussie ! ' + data.message, 'success');
                
                if (soldesData[client]) {
                    soldesData[client].solde = data.nouveau_solde;
                    const soldeDisplay = document.getElementById('solde-display');
                    soldeDisplay.innerHTML = `<strong class="text-success fs-5">${data.nouveau_solde}‚Ç¨</strong>`;
                }
                
                document.getElementById('achat-form').reset();
                document.getElementById('solde-display').innerHTML = '<span class="text-muted">S√©lectionnez un client</span>';
            } else {
                showToast('‚ùå Transaction refus√©e : ' + data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('‚ùå Erreur : ' + error.message, 'danger');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Effectuer l\'Achat S√©curis√©';
        });
    });

    // Gestion du formulaire de rechargement
    document.getElementById('client-recharge-select').addEventListener('change', function() {
        const client = this.value;
        const soldeDisplay = document.getElementById('solde-actuel-recharge');
        
        if (client && soldesData[client]) {
            const solde = soldesData[client].solde;
            soldeDisplay.innerHTML = `<strong class="text-primary fs-5">${solde}‚Ç¨</strong>`;
        } else {
            soldeDisplay.innerHTML = '<span class="text-muted">S√©lectionnez un client</span>';
        }
    });

    document.getElementById('recharge-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const client = document.getElementById('client-recharge-select').value;
        const montant = parseFloat(document.getElementById('montant-recharge-input').value);
        
        if (!client) {
            showToast('‚ùå Veuillez s√©lectionner un client', 'danger');
            return;
        }
        
        fetch('/api/recharger_compte', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                client: client,
                montant: montant
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('‚úÖ ' + data.message, 'success');
                
                // Mettre √† jour les soldes dans les deux formulaires
                if (soldesData[client]) {
                    soldesData[client].solde = data.nouveau_solde;
                    
                    // Mettre √† jour l'affichage du solde actuel
                    const soldeDisplay = document.getElementById('solde-actuel-recharge');
                    soldeDisplay.innerHTML = `<strong class="text-primary fs-5">${data.nouveau_solde}‚Ç¨</strong>`;
                    
                    // Mettre √† jour le solde dans le formulaire d'achat si le m√™me client est s√©lectionn√©
                    const clientAchat = document.getElementById('client-select').value;
                    if (clientAchat === client) {
                        const soldeDisplayAchat = document.getElementById('solde-display');
                        soldeDisplayAchat.innerHTML = `<strong class="text-success fs-5">${data.nouveau_solde}‚Ç¨</strong>`;
                    }
                }
                
                // R√©initialiser le formulaire
                document.getElementById('recharge-form').reset();
                document.getElementById('solde-actuel-recharge').innerHTML = '<span class="text-muted">S√©lectionnez un client</span>';
            } else {
                showToast('‚ùå Erreur : ' + data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('‚ùå Erreur : ' + error.message, 'danger');
        });
    });
</script>
{% endblock %}
